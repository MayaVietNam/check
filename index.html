import React from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    onAuthStateChanged, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    signOut 
} from 'firebase/auth';
import { 
    getFirestore, 
    doc, 
    setDoc, 
    addDoc, 
    collection, 
    query, 
    where, 
    getDocs,
    serverTimestamp,
    orderBy
} from 'firebase/firestore';
// This line now correctly links to your price data file.
// Please create 'price-table.js' in your 'src' folder.
import { PRICE_TABLE } from './price-table.js';

// --- IMPORTANT: PASTE YOUR FIREBASE CONFIG HERE ---
const firebaseConfig = {
  apiKey: "AIzaSyD6klJQWIelTCbST1JRsjxYkbgzA4sTgIU",
  authDomain: "ezfi-3c0f9.firebaseapp.com",
  databaseURL: "https://ezfi-3c0f9-default-rtdb.firebaseio.com",
  projectId: "ezfi-3c0f9",
  storageBucket: "ezfi-3c0f9.firebasestorage.app",
  messagingSenderId: "446492840639",
  appId: "1:446492840639:web:fba244ba9421a31dc7ec0a",
  measurementId: "G-Y5LY63RZCB"
};

// --- APP CONSTANTS (DERIVED FROM YOUR PRICE DATA) ---
const COUNTRY_LIST = Object.keys(PRICE_TABLE).sort(); 
const PACKAGE_LIST = ["500MB/ngày", "1GB/ngày", "5GB/ngày"];


// --- Initialize Firebase ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- Helper Functions ---
const currency = (val) => val != null ? Number(val).toLocaleString("vi-VN") + " VND" : "-";

const calcDays = (from, to) => {
    if (!from || !to) return 1;
    const d1 = new Date(from + 'T00:00:00Z');
    const d2 = new Date(to + 'T00:00:00Z');
    const ms = d2.getTime() - d1.getTime();
    if (ms < 0) return 1;
    return Math.round(ms / 86400000) + 1;
};

// This function now uses the imported PRICE_TABLE
const calcPrice = (country, pkg, days) => {
    if (!PRICE_TABLE[country] || !PRICE_TABLE[country][pkg] || !days) {
        return null;
    }
    const unit = PRICE_TABLE[country][pkg];
    const total = unit * days;
    const vat = Math.round(total * 0.1);
    const grandTotal = total + vat;
    return { days, total, unitPrice: unit, vat, grandTotal };
};

// --- React Components ---

// Reusable Input Component
const Input = ({ label, subLabel, id, ...props }) => (
    <div>
        <label htmlFor={id} className="block text-sm font-semibold text-blue-800 mb-1">
            {label} <span className="text-xs font-medium text-blue-500">{subLabel}</span>
        </label>
        <input id={id} className="w-full px-4 py-2 border border-blue-200 rounded-lg text-blue-900 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition" {...props} />
    </div>
);

// Reusable Select Component
const Select = ({ label, subLabel, id, children, ...props }) => (
    <div>
        <label htmlFor={id} className="block text-sm font-semibold text-blue-800 mb-1">
            {label} <span className="text-xs font-medium text-blue-500">{subLabel}</span>
        </label>
        <select id={id} className="w-full px-4 py-2 border border-blue-200 rounded-lg text-blue-900 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition" {...props}>
            {children}
        </select>
    </div>
);

// Loading Spinner
const Spinner = () => <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>;

// Main App Component
function App() {
    const [user, setUser] = React.useState(null);
    const [loading, setLoading] = React.useState(true);
    const [page, setPage] = React.useState('form'); // 'form', 'history', 'login'

    React.useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, (user) => {
            setUser(user);
            setLoading(false);
            if (user) {
                setPage('form');
            } else {
                setPage('login');
            }
        });
        return () => unsubscribe();
    }, []);

    if (loading) {
        return (
            <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                <div className="text-xl font-semibold">Loading Application...</div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-e5eefb font-sans relative">
             <div className="bg-logo-bg fixed inset-0 pointer-events-none z-0">
                <div 
                    className="absolute left-1/2 top-1/2 w-[200vw] h-[200vh] transform -translate-x-1/2 -translate-y-1/2 -rotate-10 bg-repeat opacity-[0.07]"
                    style={{backgroundImage: "url('https://i.postimg.cc/yd4v4YHG/EZ-LOGO-31.png')", backgroundSize: '120px auto'}}
                ></div>
            </div>
            <div className="relative z-10">
                <Navbar user={user} setPage={setPage} currentPage={page} />
                <main className="p-4 sm:p-8">
                    {page === 'login' && <AuthPage setPage={setPage} />}
                    {page === 'form' && user && <RentalForm user={user} />}
                    {page === 'history' && user && <HistoryPage user={user} />}
                </main>
                <Footer />
            </div>
        </div>
    );
}

// Navbar Component
function Navbar({ user, setPage, currentPage }) {
    const handleLogout = async () => {
        await signOut(auth);
        setPage('login');
    };

    return (
        <header className="bg-white/80 backdrop-blur-lg shadow-md sticky top-0 z-20">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div className="flex items-center justify-between h-20">
                    <div className="flex-shrink-0">
                        <img src="https://i.postimg.cc/VvSyGkBV/EZ-LOGO-08.png" alt="EZ Maya Logo" className="h-12 w-auto" />
                    </div>
                    <nav className="flex items-center space-x-4">
                        {user ? (
                            <>
                                <button onClick={() => setPage('form')} className={`px-3 py-2 rounded-md text-sm font-semibold ${currentPage === 'form' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'}`}>
                                    Đăng Ký Mới
                                </button>
                                <button onClick={() => setPage('history')} className={`px-3 py-2 rounded-md text-sm font-semibold ${currentPage === 'history' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'}`}>
                                    Lịch Sử
                                </button>
                                <div className="text-sm text-gray-500 hidden sm:block">{user.email}</div>
                                <button onClick={handleLogout} className="bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-600 transition">
                                    Đăng Xuất
                                </button>
                            </>
                        ) : (
                            <button onClick={() => setPage('login')} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition">
                                Đăng Nhập
                            </button>
                        )}
                    </nav>
                </div>
            </div>
        </header>
    );
}

// Auth Page (Login/Register) Component
function AuthPage({ setPage }) {
    const [isLogin, setIsLogin] = React.useState(true);
    const [email, setEmail] = React.useState('');
    const [password, setPassword] = React.useState('');
    const [error, setError] = React.useState('');
    const [loading, setLoading] = React.useState(false);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
            if (isLogin) {
                await signInWithEmailAndPassword(auth, email, password);
            } else {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                // Create a user document in Firestore
                await setDoc(doc(db, "users", userCredential.user.uid), {
                    email: userCredential.user.email,
                    createdAt: serverTimestamp()
                });
            }
            // onAuthStateChanged in App will handle redirect
        } catch (err) {
            setError(err.message);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="max-w-md mx-auto mt-10">
            <div className="bg-white p-8 rounded-2xl shadow-lg border border-blue-100">
                <h2 className="text-2xl font-bold text-center text-blue-900 mb-6">
                    {isLogin ? 'Đăng Nhập' : 'Tạo Tài Khoản'}
                </h2>
                <form onSubmit={handleSubmit} className="space-y-6">
                    <Input id="email" label="Email" type="email" value={email} onChange={e => setEmail(e.target.value)} required />
                    <Input id="password" label="Mật khẩu" subLabel="Password" type="password" value={password} onChange={e => setPassword(e.target.value)} required />
                    {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                    <button type="submit" disabled={loading} className="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition flex items-center justify-center gap-2">
                        {loading ? <Spinner /> : (isLogin ? 'Đăng Nhập' : 'Đăng Ký')}
                    </button>
                </form>
                <p className="text-center text-sm mt-6">
                    {isLogin ? "Chưa có tài khoản?" : "Đã có tài khoản?"}
                    <button onClick={() => setIsLogin(!isLogin)} className="font-semibold text-blue-600 hover:underline ml-1">
                        {isLogin ? 'Đăng ký ngay' : 'Đăng nhập'}
                    </button>
                </p>
            </div>
        </div>
    );
}


// Rental Form Component
function RentalForm({ user }) {
    const [senderInfo, setSenderInfo] = React.useState({ name: '', phone: '', company: '', region: '', taxCode: '' });
    const [requests, setRequests] = React.useState([createEmptyRequest()]);
    const [loading, setLoading] = React.useState(false);

    function createEmptyRequest() {
        return { id: Date.now(), userName: '', imei: '', fromDate: '', toDate: '', country: '', dataPackage: '', budgetCode: '' };
    }

    const handleAddRequest = () => {
        setRequests([...requests, createEmptyRequest()]);
    };

    const handleRemoveRequest = (id) => {
        if (requests.length > 1) {
            setRequests(requests.filter(req => req.id !== id));
        }
    };

    const handleRequestChange = (id, field, value) => {
        setRequests(requests.map(req => req.id === id ? { ...req, [field]: value } : req));
    };

    const handleSenderInfoChange = (field, value) => {
        setSenderInfo({ ...senderInfo, [field]: value });
    };
    
    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);

        // Basic validation
        if (!senderInfo.name || !senderInfo.phone || !senderInfo.region) {
            alert("Vui lòng nhập đủ Họ tên, Số điện thoại và Khu vực của người gửi.");
            setLoading(false);
            return;
        }

        const processedRequests = requests.map(req => {
            const days = calcDays(req.fromDate, req.toDate);
            const price = calcPrice(req.country, req.dataPackage, days);
            return { ...req, id: undefined, days, ...price }; // Remove frontend-only ID
        });
        
        const payload = {
            userId: user.uid,
            senderInfo: { ...senderInfo, email: user.email },
            rentalRequests: processedRequests,
            submissionTime: serverTimestamp(),
            status: 'Pending'
        };

        try {
            await addDoc(collection(db, "submissions"), payload);
            alert("Thành công! Đơn đăng ký đã được gửi đi. Bạn có thể xem lại trong Lịch sử.");
            setSenderInfo({ name: '', phone: '', company: '', region: '', taxCode: '' });
            setRequests([createEmptyRequest()]);
        } catch (error) {
            console.error("Error adding document: ", error);
            alert("Lỗi! Không thể gửi đơn đăng ký. Vui lòng thử lại.");
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="form-container max-w-4xl mx-auto mt-2">
            <div className="bg-white p-6 sm:p-8 rounded-2xl shadow-lg border border-blue-100">
                <h1 className="text-3xl font-extrabold text-center text-blue-900 mb-6 tracking-wide uppercase">
                    Đơn Đăng Ký Thuê Wifi
                    <span className="block text-lg font-bold text-blue-600 normal-case tracking-normal">WIFI DEVICE RENTAL REGISTRATION FORM</span>
                </h1>
                <form onSubmit={handleSubmit} noValidate>
                    <div className="border-b border-gray-200 pb-6 mb-6">
                        <h2 className="text-xl font-bold text-blue-800 mb-4">Thông Tin Người Gửi (Sender's Info)</h2>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <Input id="sender-name" label="Họ tên" subLabel="Sender's Name" value={senderInfo.name} onChange={e => handleSenderInfoChange('name', e.target.value)} required />
                            <Input id="sender-phone" label="Số điện thoại" subLabel="Phone Number" type="tel" value={senderInfo.phone} onChange={e => handleSenderInfoChange('phone', e.target.value)} required />
                            <Input id="sender-company" label="Công ty" subLabel="Company" value={senderInfo.company} onChange={e => handleSenderInfoChange('company', e.target.value)} />
                            <Input id="sender-taxcode" label="Mã số thuế" subLabel="Tax Code" value={senderInfo.taxCode} onChange={e => handleSenderInfoChange('taxCode', e.target.value)} />
                             <Select id="sender-region" label="Khu vực" subLabel="Region" value={senderInfo.region} onChange={e => handleSenderInfoChange('region', e.target.value)} required>
                                <option value="">-- Chọn khu vực --</option>
                                <option value="HN">Hà Nội (HN)</option>
                                <option value="HCM">Hồ Chí Minh (HCM)</option>
                            </Select>
                        </div>
                    </div>

                    <div className="space-y-8 mb-8">
                        {requests.map((req, index) => (
                            <RentalRequestSection 
                                key={req.id} 
                                request={req} 
                                index={index} 
                                onChange={handleRequestChange} 
                                onRemove={handleRemoveRequest}
                                showRemoveButton={requests.length > 1}
                            />
                        ))}
                    </div>

                    <div className="flex justify-center mb-8">
                        <button onClick={handleAddRequest} type="button" className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 text-md">
                            + Thêm Đơn Đăng Ký Mới
                        </button>
                    </div>

                    <div className="flex justify-center">
                        <button type="submit" disabled={loading} className="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg shadow-xl transition duration-300 text-lg flex items-center justify-center gap-3 w-64">
                            {loading ? <Spinner /> : "Gửi Yêu Cầu"}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}

// Single Rental Request Section Component
function RentalRequestSection({ request, index, onChange, onRemove, showRemoveButton }) {
    const days = calcDays(request.fromDate, request.toDate);
    const price = calcPrice(request.country, request.dataPackage, days);

    return (
        <section className="bg-blue-50 p-6 rounded-lg shadow-sm border border-blue-200 relative">
            <div className="flex justify-between items-center mb-4">
                <h3 className="text-xl font-bold text-blue-800">Đơn {index + 1} <span className="font-semibold text-base text-blue-600">(Request {index + 1})</span></h3>
                {showRemoveButton && (
                    <button type="button" onClick={() => onRemove(request.id)} className="text-red-500 hover:text-red-700 font-semibold text-sm">
                        Xóa
                    </button>
                )}
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <Input id={`user-name-${request.id}`} label="Tên người dùng" subLabel="User Name" value={request.userName} onChange={e => onChange(request.id, 'userName', e.target.value)} required />
                <Input id={`imei-${request.id}`} label="IMEI" subLabel="(Optional)" value={request.imei} onChange={e => onChange(request.id, 'imei', e.target.value)} />
                {/* FIX: Use `|| ''` to prevent passing null/undefined to the value prop of the date input */}
                <Input id={`from-date-${request.id}`} label="Từ ngày" subLabel="From date" type="date" value={request.fromDate || ''} onChange={e => onChange(request.id, 'fromDate', e.target.value)} required />
                <Input id={`to-date-${request.id}`} label="Đến ngày" subLabel="To date" type="date" value={request.toDate || ''} onChange={e => onChange(request.id, 'toDate', e.target.value)} required />
                <Select id={`country-${request.id}`} label="Quốc gia" subLabel="Country" value={request.country} onChange={e => onChange(request.id, 'country', e.target.value)} required>
                    <option value="">-- Chọn quốc gia --</option>
                    {COUNTRY_LIST.map(c => <option key={c} value={c}>{c}</option>)}
                </Select>
                <Select id={`package-${request.id}`} label="Gói data" subLabel="Data Package" value={request.dataPackage} onChange={e => onChange(request.id, 'dataPackage', e.target.value)} required>
                    <option value="">-- Chọn gói data --</option>
                    {PACKAGE_LIST.map(p => <option key={p} value={p}>{p}</option>)}
                </Select>
                <div className="md:col-span-2">
                    <Input id={`budget-code-${request.id}`} label="Mã Thanh Toán" subLabel="Budget Code (Optional)" value={request.budgetCode} onChange={e => onChange(request.id, 'budgetCode', e.target.value)} />
                </div>
                {price && (
                     <div className="price-info md:col-span-2 mt-2 text-sm">
                        <div className="bg-red-50 text-red-800 font-semibold border border-red-200 rounded-lg p-3">
                            <p>Đơn giá: {currency(price.unitPrice)} x {days} ngày = {currency(price.total)}</p>
                            <p>VAT (10%): {currency(price.vat)}</p>
                            <p className="text-blue-700 font-bold text-base mt-1">Tổng cộng: {currency(price.grandTotal)}</p>
                        </div>
                    </div>
                )}
            </div>
        </section>
    );
}

// History Page Component
function HistoryPage({ user }) {
    const [submissions, setSubmissions] = React.useState([]);
    const [loading, setLoading] = React.useState(true);

    React.useEffect(() => {
        const fetchSubmissions = async () => {
            if (!user) return;
            setLoading(true);
            try {
                const q = query(
                    collection(db, "submissions"), 
                    where("userId", "==", user.uid),
                    orderBy("submissionTime", "desc")
                );
                const querySnapshot = await getDocs(q);
                const subs = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setSubmissions(subs);
            } catch (error) {
                console.error("Error fetching submissions:", error);
                alert("Could not fetch submission history.");
            } finally {
                setLoading(false);
            }
        };
        fetchSubmissions();
    }, [user]);

    return (
        <div className="max-w-7xl mx-auto mt-2">
            <div className="bg-white p-6 sm:p-8 rounded-2xl shadow-lg border border-blue-100">
                <h1 className="text-3xl font-extrabold text-blue-900 mb-6">Lịch Sử Đăng Ký</h1>
                {loading ? (
                    <p>Loading history...</p>
                ) : submissions.length === 0 ? (
                    <p>Bạn chưa có đơn đăng ký nào.</p>
                ) : (
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left text-gray-600">
                            <thead className="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th scope="col" className="px-6 py-3">Ngày Gửi</th>
                                    <th scope="col" className="px-6 py-3">Người Gửi</th>
                                    <th scope="col" className="px-6 py-3">Số Lượng Đơn</th>
                                    <th scope="col" className="px-6 py-3">Tổng Tiền</th>
                                    <th scope="col" className="px-6 py-3">Trạng Thái</th>
                                </tr>
                            </thead>
                            <tbody>
                                {submissions.map(sub => {
                                    const totalAmount = sub.rentalRequests.reduce((acc, req) => acc + (req.grandTotal || 0), 0);
                                    return (
                                        <tr key={sub.id} className="bg-white border-b hover:bg-gray-50">
                                            <td className="px-6 py-4">{sub.submissionTime?.toDate().toLocaleString('vi-VN')}</td>
                                            <td className="px-6 py-4 font-medium text-gray-900">{sub.senderInfo.name}</td>
                                            <td className="px-6 py-4">{sub.rentalRequests.length}</td>
                                            <td className="px-6 py-4 font-semibold">{currency(totalAmount)}</td>
                                            <td className="px-6 py-4">
                                                <span className="px-2 py-1 font-semibold leading-tight text-green-700 bg-green-100 rounded-full">
                                                    {sub.status}
                                                </span>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                )}
            </div>
        </div>
    );
}

// Footer Component
function Footer() {
    return (
        <footer className="mt-12 mb-4">
            <div className="max-w-3xl mx-auto text-center text-sm text-gray-600 bg-white/60 p-6 rounded-2xl shadow-md border border-blue-100">
                <h2 className="font-bold text-lg text-red-600 uppercase">CÔNG TY TNHH MAYA VIETNAM</h2>
                <p className="font-semibold text-blue-600">MAYA VIETNAM CO., LTD</p>
                <p className="mt-2">
                    <span className="font-semibold">Địa chỉ:</span> Phòng 1630, Tầng 16, DAEHA BUSINESS CENTER, 360 Kim Mã, Giảng Võ, Hà Nội
                </p>
                <p className="mt-2">
                    <span className="font-semibold">Hotline:</span>
                    <span className="text-red-600 font-bold mx-2">0962 000 650</span> (Tiếng Việt) |
                    <span className="text-blue-600 font-bold mx-2">0365 399 288</span> (Tiếng Nhật)
                </p>
            </div>
        </footer>
    );
}

export default App;
